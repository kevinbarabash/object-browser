<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title></title>
  <style>
    body {
      font-family: 'monaco', 'lucida console', monospace;
      font-size: 12pt;
    }

    .label {
      color: rgb(200,0,200);
    }

    .read-only {
      color: rgb(220,160,220);
    }

    .number, .boolean {
      color: rgb(0,0,255);
    }

    .string {
      color: rgb(255,0,0);
    }

    .triangle {
      position:absolute;
      width:1.5em;
      left:-1.5em;
      top:0.25em;
      text-align:center;
      font-size:0.75em;
      color: #666;
      cursor: pointer;
    }

    ul.props {
      margin: 0;
      list-style-type: none;
    }
  </style>
  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <script src="bower_components/observe-js/src/observe.js"></script>
</head>
<body>

<button id="update">Update</button>

</body>
</html>
<script>

  var obj = {
    x: 5,
    y: 10,
    items: ["apple", "pineapple", [1,2,3]],
    sub: {
      p: 1,
      q: -1
    },
    message: "hello, world",
    on: false
  };

  function createSpan(text, cls) {
    return "<span class='" + cls + "'>" + text + "</span>";
  }

  function createLabel(text) {
    return createSpan(text, "label");
  }

  function createString(text) {
    return createSpan('"' + text + '"', "string");
  }

  function genPreview(value, stop) {
    if (typeof(value) === "object") {
      if (value instanceof Array) {
        return "Array[" + value.length + "]";
      } else {
        if (stop) {
          return "Object";
        } else {
          var result = "Object {";
          var keys = Object.keys(value);
          for (var i = 0; i < keys.length; i++) {
            if (i > 0) {
              result += ", ";
            }
            var key = keys[i];
            result += createLabel(key) + ": ";
            result += genPreview(value[key], true);
          }
          result += "}";
          return result;
        }
      }
    } else if (typeof(value) === "number") {
      return createSpan(value, "number");
    } else if (typeof(value) === "string") {
      return createString(value);
    } else if (typeof(value) === "boolean") {
      return createSpan(value, "boolean");
    }
  }

  function genPropsList(value, hidden) {
    var result = "";
    if (hidden) {
      result = "<ul class='props' style='display:none;'>";
    } else {
      result = "<ul class='props'>";
    }
    var keys = Object.keys(value);
    for (var i = 0; i < keys.length; i++) {
      var key = keys[i];
      if (typeof(value[key]) === "object") {
        result += "<li style='position:relative;'><span class='triangle'>&#x25B6;</span>";
        result += createLabel(key) + ": " + genPreview(value[key], true);
        result += genPropsList(value[key], true);
      } else {
        result += "<li>";
        result += createLabel(key) + ": ";
        result += genPreview(value[key], true);
      }
      result += "</li>";
    }
    if (value instanceof Array) {
      result += createSpan("length", "read-only") + ": " + genPreview(value.length);
    }
    result += "</ul>";
    return result;
  }

//  var preview = genPreview(obj);
//  $(document.body).append(preview);

  $(document.body).append(genPropsList(obj));

  $('.triangle').click(function () {
    var $ul = $(this).parent().find('> ul');
    $ul.toggle();
    if ($ul.is(':visible')) {
      $(this).text('\u25BC');
    } else {
      $(this).text('\u25B6');
    }
  });

  var observer = new ObjectObserver(obj);
  observer.open(function(added, removed, changed, getOldValueFn) {
    if (Object.keys(added).length > 0) {
      console.log("added: %o", added);
    }
    if (Object.keys(removed).length > 0) {
      console.log("removed: %o", removed);
    }
    if (Object.keys(changed).length > 0) {
      console.log("chnaged: %o", changed);
    }
  });

  var observer2 = new ObjectObserver(obj.sub);
  observer2.open(function(added, removed, changed, getOldValueFn) {
    if (Object.keys(added).length > 0) {
      console.log("added: %o", added);
    }
    if (Object.keys(removed).length > 0) {
      console.log("removed: %o", removed);
    }
    if (Object.keys(changed).length > 0) {
      console.log("chnaged: %o", changed);
    }
  });

  document.querySelector("#update").addEventListener("click", function () {
    obj.x = 3 * obj.x;
    obj.sub.p = 0;
    obj.sub.r = 2;
    delete obj.on;
    obj.newProp = "new prop";
    obj.newProp2 = 2;

    Platform.performMicrotaskCheckpoint();

    var root = $("ul.props").get(0);

    $(root).replaceWith(genPropsList(obj));

    $('.triangle').click(function () {
      var $ul = $(this).parent().find('> ul');
      $ul.toggle();
      if ($ul.is(':visible')) {
        $(this).text('\u25BC');
      } else {
        $(this).text('\u25B6');
      }
    });
  });



</script>